<html lang="en">
<head>
		<title>Yuka | Tic-Tac-Toe</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="../../lib/styles.css">
		<style>
			#container {
				display: flex;
				align-items: center;
				justify-content: center;
				height: 100%;
				width: 100%;
			}
			.row {
				display: flex;
				justify-content: center;
			}
			.cell {
				width: 200px;
				height: 200px;
				line-height: 200px;
				margin: 8px;
				background-color: #ee0808;
				color: #ffffff;
				text-align: center;
				font-size: 200px;
			}
			button {
				height: 20px;
				width: 120px;
				color: #ffffff;
				background: transparent;
				outline: 1px solid #ffffff;
				border: 0px;
				cursor: pointer;
			}
			#restart {
				display: none;
			}
		</style>
</head>
<body>

	<section id="intro">
		<p>
			Welcome to "Tic-Tac-Toe"
		</p>
		<p class="sub">
			Do you want to make the first move?
		</p>
		<p>
			<button type="button" data-player="1">Yes please!</button> <button type="button" data-player="2">Let the AI begin!</button>
		</p>
		<p>
			<a id="restart" href="#">Restart Game</a>
		</p>
	</section>

	<section id="container">
		<section id="board">
			<div class="row">
				<div class="cell" data-cellId="0"></div>
				<div class="cell" data-cellId="1"></div>
				<div class="cell" data-cellId="2"></div>
			</div>
			<div class="row">
				<div class="cell" data-cellId="3"></div>
				<div class="cell" data-cellId="4"></div>
				<div class="cell" data-cellId="5"></div>
			</div>
			<div class="row">
				<div class="cell" data-cellId="6"></div>
				<div class="cell" data-cellId="7"></div>
				<div class="cell" data-cellId="8"></div>
			</div>
		</section>
	</section>

<script type="module">

	import { TTTGraph } from './src/TTTGraph.js';

	let player, graph, fin = false;

	initUI();

	function initUI()Â {

		// init buttons

		const buttons = document.querySelectorAll( 'button' );

		for ( let button of buttons ) {

			button.addEventListener( 'click', onButtonClick );

		}

		// init cells

		const cells = document.querySelectorAll( '.cell' );

		for ( let cell of cells ) {

			cell.addEventListener( 'click', onCellClick );

		}

	}

	function initGame() {

		const intro = document.getElementById( 'intro' );
		intro.classList.add( 'hidden' );

		// create game state graph

		graph = new TTTGraph( player );

		// let the ai make its first move

		if ( player === 2 ) {

			graph.aiTurn();
			updateUI();

		}

	}

	function onButtonClick( event ) {

		const button = event.target;
		player = parseInt( button.dataset.player );

		initGame();

	}

	function onCellClick( event ) {

		if ( fin === false ) {

			const cell = event.target;
			const cellid = cell.dataset.cellid;

			graph.turn( cellid, graph.currentPlayer );
			evaluate();

			if ( fin === false ) {

				graph.aiTurn();
				evaluate();

			}

			updateUI();

		}

	}

	function evaluate() {

		const node = graph.getNode( graph.currentNode );

		if ( node.isWin === true || node.filled === 9 ) fin = true;

	}

	function updateUI() {

		const node = graph.getNode( graph.currentNode );

		const board = node.field;
		const cells = document.querySelectorAll( '.cell' );

		for ( let cell of cells ) {

			const cellid = cell.dataset.cellid;
			const status = board[ cellid ];

			switch ( status ) {

				case 1:
					cell.textContent = 'X';
					cell.removeEventListener( 'click', onCellClick );
					break;

				case 2:
					cell.textContent = 'O';
					cell.removeEventListener( 'click', onCellClick );
					break;

				default:
					cell.textContent = '';
					break;

			}

		}

		if ( fin === true ) {

			const intro = document.getElementById( 'intro' );
			intro.classList.remove( 'hidden' );

			intro.innerHTML = '';

			if ( node.isWin === true ) {

				if ( node.winPlayer === player ) {

					intro.textContent = 'You win the game!';

				} else {

					intro.textContent = 'The AI wins the game!';

				}

			} else {

				intro.textContent = 'Draw!';

			}

		}

	}

</script>

</body>
</html>
